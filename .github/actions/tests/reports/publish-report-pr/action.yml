name: Publish PR test report
permissions: {}

inputs:
    key-id:
        required: true
    region:
        required: true
    access-key:
        required: true
    reports-home:
        required: true
    allure-report-dir:
        required: true
        description: Path to allure-report folder.
    feat-slug:
        description: Slug for enabled feature flags.
    test-type:
        required: true
        type: choice
        options:
            - api
            - e2e
            - k6

runs:
    using: composite
    steps:
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v2
          with:
              aws-region: ${{ inputs.region }}
              aws-access-key-id: ${{ inputs.key-id }}
              aws-secret-access-key: ${{ inputs.access-key }}

        - name: Set upload path
          uses: actions/github-script@v6
          id: upload-path
          env:
              SCRIPT_PATH: ./.github/actions/tests/reports/publish-report-pr/scripts/set-upload-path.js
              PR_NUMBER: ${{ github.event.pull_request.number }}
              REPORTS_HOME: ${{ inputs.reports-home }}
              FEAT_SLUG: ${{ inputs.feat-slug }}
              TEST_TYPE: ${{ inputs.test-type }}
          with:
              result-encoding: string
              script: |
                  const script = require( process.env.SCRIPT_PATH );
                  return script();

        - name: Upload report
          shell: bash
          env:
              SOURCE: ${{ inputs.allure-report-dir }}
              TARGET: ${{ steps.upload-path.outputs.result }}
          run: |
              aws s3 cp "${{ env.SOURCE }}" "${{ env.TARGET }}" \
                --recursive \
                --only-show-errors

          # mytodo add link to report
