name: Publish PR test report
description: Upload allure-report folder to bucket. Add link on WooCommerce Test Reports Dashboard.
permissions: {}

inputs:
    key-id:
        required: true
    region:
        required: true
    access-key:
        required: true
    reports-home:
        required: true
    feat-slug:
        description: Slug for enabled feature flags.
    test-type:
        required: true
        type: choice
        options:
            - api
            - e2e
            - k6

outputs:
    report-url:
        description: Link to view published report.
        value: ${{ steps.upload-path.outputs.report-url }}
    stats:
        description: Stringified JSON of test result stats.
        value: ${{ steps.stats.outputs.stats }}

runs:
    using: composite
    steps:
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v2
          with:
              aws-region: ${{ inputs.region }}
              aws-access-key-id: ${{ inputs.key-id }}
              aws-secret-access-key: ${{ inputs.access-key }}

        - name: Set upload path
          uses: actions/github-script@v6
          id: upload-path
          env:
              SCRIPT_PATH: ./.github/actions/tests/reports/publish-report-pr/scripts/set-upload-path.js
              PR_NUMBER: ${{ github.event.pull_request.number }}
              REPORTS_HOME: ${{ inputs.reports-home }}
              FEAT_SLUG: ${{ inputs.feat-slug }}
              TEST_TYPE: ${{ inputs.test-type }}
          with:
              result-encoding: string
              script: |
                  const script = require( process.env.SCRIPT_PATH );
                  script( { core } );

        - name: Upload report
          shell: bash
          env:
              SOURCE: ${{ env.ALLURE_REPORT_DIR }}
              TARGET: ${{ steps.upload-path.outputs.upload-path }}
          run: |
              aws s3 cp "${{ env.SOURCE }}" "${{ env.TARGET }}" \
                --recursive \
                --only-show-errors

        - name: Output test stats
          id: stats
          uses: actions/github-script@v6
          env:
              SCRIPT_PATH: ./.github/actions/tests/reports/publish-report-pr/scripts/output-stats.js
          with:
              script: |
                  const script = require( process.env.SCRIPT_PATH );
                  script( { core } );
